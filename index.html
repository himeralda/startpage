<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>~/startpage</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="x-icon" href="favicon.ico">
</head>

<body>
    <div class="container">
        <div class="left-container">
            <!-- Settings button added here -->
            <button id="settings-button" class="top-left-link-button"></button>
            <div class="gif">
                <img src="koga.png" />
            </div>
        </div>

        <div class="right-container">
            <!-- Three link buttons added here -->
            <a href="https://www.dmm.com/" class="top-right-link-button button-1" target="_blank"></a>
            <a href="https://mail.google.com/" class="top-right-link-button button-2" target="_blank"></a>
            <a href="https://maps.google.com" class="top-right-link-button button-3" target="_blank"></a>
            <div class="datetime-container">
                <div id="current-datetime"></div>
            </div>
            <div class="head">
                <!-- Modified for search bar functionality -->
                <span id="prompt-prefix">> cd ~/</span><span id="search-text"></span><span id="blinker" class="blinking">_</span>
            </div>

            <div class="bookmarks" id="bookmarks-container">
                <!-- Bookmark categories will be loaded here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Edit Bookmarks</h2>
            <div id="modal-categories">
                <!-- Categories will be loaded here -->
            </div>
            <button id="add-category-button" class="modal-button">Add New Category</button>
            <button id="save-settings-button" class="modal-button">Save Changes</button>
        </div>
    </div>

    <script>
        // Function to update the clock and date
        function updateDateTime() {
            const now = new Date();

            // Format time for 12-hour clock with AM/PM
            let hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // The hour '0' should be '12'
            const timeString = `${String(hours).padStart(2, '0')}:${minutes}:${seconds} ${ampm}`;

            // Format date
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);

            document.getElementById('current-datetime').textContent = `${dateString} ${timeString}`;
        }

        // Update the clock every second
        setInterval(updateDateTime, 1000);

        // Initial call to display the time immediately
        updateDateTime();

        // Search bar functionality
        const searchTextElement = document.getElementById('search-text');
        const blinkerElement = document.getElementById('blinker');
        let searchQuery = '';

        // Function to validate if a string is a URL
        function isValidUrl(string) {
            const urlRegex = /^(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/[a-zA-Z0-9]+\.[^\s]{2,}|[a-zA-Z0-9]+\.[^\s]{2,})$/i;
            return urlRegex.test(string);
        }

        document.addEventListener('keydown', (event) => {
            // Prevent default behavior for Backspace, Enter, and single character keys if modal is not open
            if (!settingsModal.classList.contains('show')) {
                if (event.key === 'Backspace' || event.key === 'Enter' || event.key.length === 1) {
                    event.preventDefault();
                }

                if (event.key === 'Backspace') {
                    searchQuery = searchQuery.slice(0, -1);
                } else if (event.key === 'Enter') {
                    const trimmedQuery = searchQuery.trim();
                    if (trimmedQuery !== '') {
                        if (isValidUrl(trimmedQuery)) {
                            let urlToOpen = trimmedQuery;
                            if (!urlToOpen.startsWith('http://') && !urlToOpen.startsWith('https://')) {
                                urlToOpen = `http://${urlToOpen}`;
                            }
                            window.open(urlToOpen, '_blank');
                        } else {
                            window.open(`https://www.duckduckgo.com/search?q=${encodeURIComponent(trimmedQuery)}`, '_blank');
                        }
                    }
                    searchQuery = '';
                } else if (event.key.length === 1) {
                    searchQuery += event.key;
                }
                searchTextElement.textContent = searchQuery;
            }
        });


        // Initial bookmark data (example structure)
        let bookmarksData = JSON.parse(localStorage.getItem('bookmarksData')) || [
            {
                title: 'learn',
                links: [
                    { text: 'archive.org', url: 'https://archive.org', starred: false },
                    { text: 'bpl resources', url: 'https://www.bpl.org/resource/', starred: false },
                    { text: 'mvlc', url: 'https://ma-burlingtonlibrary.civicplus.com/248/Online-Resources', starred: false },
                    { text: 'open-slum', url: 'https://open-slum.org/', starred: false },
                    { text: 'times machine', url: 'https://timesmachine.nytimes.com/browser', starred: false },
                ]
            },
            {
                title: 'dev',
                links: [
                    { text: 'color converter', url: 'https://www.w3schools.com/colors/colors_converter.asp', starred: false },
                    { text: 'neocities', url: 'https://neocities.org/', starred: false },
                    { text: 'bellingcat', url: 'https://challenge.bellingcat.com/', starred: false },
                    { text: 'extra 4', url: '#', starred: false },
                    { text: 'extra 5', url: '#', starred: false },
                ]
            },
            {
                title: 'database',
                links: [
                    { text: 'toumyu', url: 'https://musical-toukenranbu.jp/', starred: false },
                    { text: 'esute', url: 'https://www.mankai-stage.jp/', starred: false },
                    { text: 'mahosute', url: 'https://mahoyaku-stage.com/', starred: false },
                    { text: 'ryoya', url: 'https://ryoya-takahashi.net/dashboard', starred: false },
                ]
            },
            {
                title: 'fandom',
                links: [
                    { text: 'tkrb wiki', url: 'https://touken-ranbu.fandom.com/', starred: false },
                    { text: 'fgo', url: 'https://grandorder.gamepress.gg/', starred: false },
                    { text: 'crk', url: 'https://www.mrguider.org/guides/cookie-run-kingdom-toppings-guide-best-toppings/', starred: false },
                    { text: 'limbus', url: 'https://limbuscompany.wiki.gg/', starred: false },
                    { text: 'tamaatsume', url: 'http://deltarium.org/tokenranbu/tamaatsume/', starred: false },
                ]
            },
            {
                title: 'social',
                links: [
                    { text: 'twitter', url: 'https://twitter.com/', starred: false },
                    { text: 'youtube', url: 'https://youtube.com/', starred: false },
                    { text: 'reddit', url: 'https://reddit.com/', starred: false },
                    { text: 'pixiv', url: 'https://pixiv.net/', starred: false },
                    { text: 'bluesky', url: 'https://bsky.app/', starred: false },
                ]
            },
            {
                title: 'media',
                links: [
                    { text: 'mynoise', url: 'https://mynoise.net/', starred: false },
                    { text: 'radio', url: 'https://radio.garden/browse', starred: false },
                    { text: 'dmm', url: 'https://dmm.com', starred: false },
                    { text: 'tv', url: 'http://putlocker.pe/', starred: false },
                ]
            },
            {
                title: 'misc',
                links: [
                    { text: 'extra 5', url: '#', starred: false },
                    { text: 'extra 5', url: '#', starred: false },
                ]
            },
                        {
                title: 'a secret ninth thing',
                links: [
                    { text: 'extra 5', url: '#', starred: false },
                    { text: 'extra 5', url: '#', starred: false },
                ]
            }
        ];

        const linksPerPage = 5; // Number of links to show per page

        // Function to render bookmarks
        function renderBookmarks() {
            const bookmarksContainer = document.getElementById('bookmarks-container');
            bookmarksContainer.innerHTML = ''; // Clear existing bookmarks

            bookmarksData.forEach(categoryData => {
                const categoryDiv = document.createElement('div');
                categoryDiv.classList.add('category');

                const linksDiv = document.createElement('div');
                linksDiv.classList.add('links');

                const titleLi = document.createElement('li');
                titleLi.classList.add('title');
                titleLi.textContent = categoryData.title;
                linksDiv.appendChild(titleLi);

                // Create and store all original link elements, applying starred class if needed
                // This map now directly creates the <li> elements with the correct <a> tags
                categoryData.allOriginalLinks = categoryData.links.map(link => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = link.url;
                    a.textContent = link.text;
                    a.target = "_blank";
                    if (link.starred) {
                        a.classList.add('starred-link');
                    }
                    li.appendChild(a);
                    return li;
                });
                categoryData.currentPage = 0; // Initialize current page

                // Only append the visible links based on the current page
                const startIndex = categoryData.currentPage * linksPerPage;
                const endIndex = startIndex + linksPerPage;
                for (let i = startIndex; i < endIndex && i < categoryData.allOriginalLinks.length; i++) {
                    linksDiv.appendChild(categoryData.allOriginalLinks[i]);
                }

                categoryDiv.appendChild(linksDiv);

                const toggleButton = document.createElement('button');
                toggleButton.classList.add('toggle-links-button');
                toggleButton.textContent = '>';
                categoryDiv.appendChild(toggleButton);

                bookmarksContainer.appendChild(categoryDiv);

                // Initial display of links for each category (now handled implicitly by initial append)
                // However, the toggle button visibility needs to be handled
                if (categoryData.allOriginalLinks.length <= linksPerPage) {
                    toggleButton.style.display = 'none'; // Hide button if no pagination needed
                } else {
                    toggleButton.style.display = 'block'; // Show button if pagination is needed
                }


                // Add click listener to the toggle button
                toggleButton.addEventListener('click', () => {
                    categoryData.currentPage++; // Move to the next page
                    // If we've gone past the last page, loop back to the first page (page 0)
                    if (categoryData.currentPage * linksPerPage >= categoryData.allOriginalLinks.length) {
                        categoryData.currentPage = 0;
                    }
                    // Re-render links for this specific category
                    linksDiv.innerHTML = ''; // Clear existing links
                    linksDiv.appendChild(titleLi); // Re-add the title

                    const newStartIndex = categoryData.currentPage * linksPerPage;
                    const newEndIndex = newStartIndex + linksPerPage;

                    for (let i = newStartIndex; i < newEndIndex && i < categoryData.allOriginalLinks.length; i++) {
                        const currentLi = categoryData.allOriginalLinks[i];
                        const currentLinkData = categoryData.links[i]; // Get the actual data object

                        // Ensure the 'starred-link' class is correctly applied/removed
                        const aElement = currentLi.querySelector('a');
                        if (aElement) {
                            if (currentLinkData.starred) {
                                aElement.classList.add('starred-link');
                            } else {
                                aElement.classList.remove('starred-link');
                            }
                        }
                        linksDiv.appendChild(currentLi);
                    }
                });
            });
        }


        // Settings Modal Logic
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeButton = settingsModal.querySelector('.close-button');
        const modalCategoriesContainer = document.getElementById('modal-categories');
        const addCategoryButton = document.getElementById('add-category-button');
        const saveSettingsButton = document.getElementById('save-settings-button');

        // Open modal
        settingsButton.addEventListener('click', () => {
            settingsModal.classList.add('show');
            renderModalContent();
        });

        // Close modal
        closeButton.addEventListener('click', () => {
            settingsModal.classList.remove('show');
        });

        // Close modal when clicking outside content
        window.addEventListener('click', (event) => {
            if (event.target == settingsModal) {
                settingsModal.classList.remove('show');
            }
        });

        // Render content inside the modal
        function renderModalContent() {
            modalCategoriesContainer.innerHTML = ''; // Clear existing content

            bookmarksData.forEach((category, categoryIndex) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.classList.add('modal-category-item');
                categoryDiv.dataset.categoryIndex = categoryIndex;

                const categoryHeader = document.createElement('div');
                categoryHeader.classList.add('modal-category-header');

                const categoryTitleInput = document.createElement('input');
                categoryTitleInput.type = 'text';
                categoryTitleInput.value = category.title;
                categoryTitleInput.classList.add('category-title-input');
                categoryTitleInput.addEventListener('change', (e) => {
                    category.title = e.target.value;
                });
                categoryHeader.appendChild(categoryTitleInput);

                const deleteCategoryButton = document.createElement('button');
                deleteCategoryButton.classList.add('delete-button');
                deleteCategoryButton.textContent = 'Delete Category';
                deleteCategoryButton.addEventListener('click', () => {
                    // Use a custom confirmation dialog instead of alert()
                    const confirmDelete = document.createElement('div');
                    confirmDelete.classList.add('custom-confirm');
                    confirmDelete.innerHTML = `
                        <p>Are you sure you want to delete this category?</p>
                        <button id="confirm-yes">Yes</button>
                        <button id="confirm-no">No</button>
                    `;
                    document.body.appendChild(confirmDelete);

                    document.getElementById('confirm-yes').addEventListener('click', () => {
                        bookmarksData.splice(categoryIndex, 1);
                        renderModalContent(); // Re-render modal after deletion
                        document.body.removeChild(confirmDelete);
                    });

                    document.getElementById('confirm-no').addEventListener('click', () => {
                        document.body.removeChild(confirmDelete);
                    });
                });
                categoryHeader.appendChild(deleteCategoryButton);
                categoryDiv.appendChild(categoryHeader);

                const linksList = document.createElement('div');
                linksList.classList.add('modal-links-list');

                category.links.forEach((link, linkIndex) => {
                    const linkItem = document.createElement('div');
                    linkItem.classList.add('modal-link-item');

                    // Star checkbox/button
                    const starButton = document.createElement('button');
                    starButton.classList.add('star-button');
                    starButton.innerHTML = link.starred ? '★' : '☆'; // Unicode star characters
                    starButton.title = link.starred ? 'Unstar Link' : 'Star Link';
                    if (link.starred) {
                        starButton.classList.add('is-starred');
                    }
                    starButton.addEventListener('click', () => {
                        link.starred = !link.starred;
                        renderModalContent(); // Re-render to update star icon
                    });
                    linkItem.appendChild(starButton);


                    const linkTextInput = document.createElement('input');
                    linkTextInput.type = 'text';
                    linkTextInput.value = link.text;
                    linkTextInput.placeholder = 'Link Text';
                    linkTextInput.addEventListener('change', (e) => {
                        link.text = e.target.value;
                    });
                    linkItem.appendChild(linkTextInput);

                    const linkUrlInput = document.createElement('input');
                    linkUrlInput.type = 'url';
                    linkUrlInput.value = link.url;
                    linkUrlInput.placeholder = 'Link URL';
                    linkUrlInput.addEventListener('change', (e) => {
                        link.url = e.target.value;
                    });
                    linkItem.appendChild(linkUrlInput);

                    const deleteLinkButton = document.createElement('button');
                    deleteLinkButton.classList.add('delete-button');
                    deleteLinkButton.textContent = 'Delete Link';
                    deleteLinkButton.addEventListener('click', () => {
                        category.links.splice(linkIndex, 1);
                        renderModalContent(); // Re-render modal after deletion
                    });
                    linkItem.appendChild(deleteLinkButton);

                    linksList.appendChild(linkItem);
                });

                const addLinkButton = document.createElement('button');
                addLinkButton.classList.add('add-link-button');
                addLinkButton.textContent = 'Add Link';
                addLinkButton.addEventListener('click', () => {
                    category.links.push({ text: '', url: '', starred: false }); // New links are not starred by default
                    renderModalContent(); // Re-render modal to show new link
                });
                linksList.appendChild(addLinkButton);

                categoryDiv.appendChild(linksList);
                modalCategoriesContainer.appendChild(categoryDiv);
            });
        }

        // Add New Category
        addCategoryButton.addEventListener('click', () => {
            bookmarksData.push({ title: 'New Category', links: [{ text: '', url: '', starred: false }] });
            renderModalContent();
        });

        // Save Settings
        saveSettingsButton.addEventListener('click', () => {
            // Filter out empty links and categories if desired, or handle validation
            // For now, just save the current state
            localStorage.setItem('bookmarksData', JSON.stringify(bookmarksData));
            settingsModal.classList.remove('show');
            renderBookmarks(); // Re-render main page bookmarks
        });

        // Initial render of bookmarks when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            renderBookmarks();
        });
    </script>
</body>

</html>
